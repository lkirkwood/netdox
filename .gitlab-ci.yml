---
image: "rust:latest"

services:
  - redis:latest

debug:
  stage: .pre
  tags:
    - docker
  script:
    - rustc --version
    - cargo --version
    - rustup --version

test:
  stage: test
  tags:
    - docker
  script:
    - apt-get update && apt-get install netcat-traditional
    - >-
      cat functions.lua |
      sed "s/\"/'/g" |
      awk 'ORS=""; NR == 1 {print "FUNCTION LOAD REPLACE \""}
      $1 !~ /^--|^$/ {print $0 "\\\\n"} END {print "\"\n"}' |
      nc -q1 redis 6379
    - cargo test --verbose

lint:
  stage: test
  tags:
    - docker
  script:
    - rustup component add rustfmt
    - rustup component add clippy
    - cargo fmt --check
    - cargo clippy -- -D warnings
