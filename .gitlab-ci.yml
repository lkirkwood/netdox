---
image: "rust:1.77-alpine3.18"

services:
  - redis:latest

debug:
  stage: .pre
  script:
    - rustup component add rustfmt
    - rustup component add clippy
    - rustc --version
    - cargo --version

test:
  stage: test
  script:
    - >-
      cat functions.lua |
      sed 's/"/\'/g' |
      awk 'ORS=""; NR == 1 {print "FUNCTION LOAD REPLACE \""}
      $1 !~ /^--|^$/ {print $0 "\\\\n"} END {print "\"\n"}' |
      nc -N localhost 9999
    - cargo test --verbose

lint:
  stage: test
  script:
    - cargo fmt --check
    - cargo clippy -- -D warnings
