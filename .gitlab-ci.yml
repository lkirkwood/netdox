---
image: "rust:latest"

stages:
  - .pre
  - test
  - build

services:
  - redis:latest

debug:
  stage: .pre
  tags:
    - docker
  script:
    - rustc --version
    - cargo --version
    - rustup --version

test:
  stage: test
  tags:
    - docker
  script:
    - apt-get update && apt-get install netcat-traditional
    - >-
      cat functions.lua |
      sed "s/\"/'/g" |
      awk 'ORS=""; NR == 1 {print "FUNCTION LOAD REPLACE \""}
      $1 !~ /^--|^$/ {print $0 "\\\\n"} END {print "\"\n"}' |
      nc -q1 redis 6379
    - cargo test --verbose

lint:
  stage: test
  tags:
    - docker
  script:
    - rustup component add rustfmt
    - rustup component add clippy
    - cargo fmt --check
    - cargo clippy -- -D warnings

build-image:
  image: quay.io/buildah/stable
  stage: build
  needs:
    - test
    - lint
  tags:
    - docker
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | buildah login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - buildah build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG .
    - buildah push $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
